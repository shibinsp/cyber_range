# Logstash Pipeline: Sysmon Logs
# Processes Windows Sysmon events and indexes to Elasticsearch

input {
  beats {
    port => 5044
    tags => ["sysmon"]
  }
}

filter {
  if "sysmon" in [tags] {
    # Parse Sysmon XML
    xml {
      source => "message"
      target => "sysmon"
      store_xml => false
      xpath => [
        "/Event/System/EventID/text()", "event_id",
        "/Event/EventData/Data[@Name='ProcessId']/text()", "process_id",
        "/Event/EventData/Data[@Name='Image']/text()", "image",
        "/Event/EventData/Data[@Name='CommandLine']/text()", "command_line"
      ]
    }

    # Add metadata
    mutate {
      add_field => {
        "[@metadata][index_name]" => "sysmon-%{+YYYY.MM.dd}"
      }
    }

    # Enrich with GeoIP (if external IPs present)
    if [destination_ip] {
      geoip {
        source => "destination_ip"
        target => "geoip"
      }
    }

    # Calculate risk score (simple example)
    ruby {
      code => '
        risk_score = 0
        risk_score += 10 if event.get("command_line") =~ /powershell/i
        risk_score += 15 if event.get("command_line") =~ /invoke-expression/i
        risk_score += 20 if event.get("command_line") =~ /downloadstring/i
        event.set("risk_score", risk_score)
      '
    }
  }
}

output {
  if "sysmon" in [tags] {
    elasticsearch {
      hosts => ["${ELASTICSEARCH_URL:http://elasticsearch:9200}"]
      index => "%{[@metadata][index_name]}"
      document_type => "_doc"
    }

    # Also send to stdout for debugging
    if [@metadata][debug] {
      stdout {
        codec => rubydebug
      }
    }
  }
}
